#!/bin/sh
ACTIONS_DIR="$HOME/.actions"

# 1. READ TARGET ID (Still static, the pane ID doesn't change)
TARGET_PANE=$(cat "$HOME/.config/zsh/.actions_target_id")

# --- FZF Helper ---
pick_item() {
  dir="$1"
  display_dir=$(basename "$dir")
  items=$(find "$dir" -mindepth 1 -maxdepth 1 \
            \( -type d -print -o -type f -exec test -x {} \; -print \) \
          | sort | sed 's#.*/##')
  [ -z "$items" ] && return 1
  printf '%s\n' "$items" | fzf --prompt="$display_dir > "
}

# --- Main Loop ---
current="$ACTIONS_DIR"
while true; do
  choice=$(pick_item "$current") || exit 0
  
  # Directory Navigation
  selected_path="$current/$choice"
  if [ -d "$selected_path" ]; then
    current="$selected_path"
    continue
  fi

  # --- EXECUTION ---
  
  # 2. JUST-IN-TIME DETECTION (The Fix)
  #    We check the path NOW, right when you decided to run the action.
  #    If you changed directories 1 second ago, this catches it.
  TARGET_CWD=$(tmux display-message -p -t "$TARGET_PANE" '#{pane_current_path}')

  # 3. Construct Command
  SAFE_CMD="(cd \"$TARGET_CWD\" && \"$selected_path\")"
  
  tmux send-keys -t "$TARGET_PANE" "$SAFE_CMD" Enter
  
  sleep 0.1
  exit 0
done
